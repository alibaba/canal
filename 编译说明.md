# 如何编译

## 修改POM

client-adapter.escore的pom.xml的关于druid的配置，需要设置scope为provider
之前的配置是:

```xml
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
</dependency>
```

修改之后的配置为：

```xml
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
  <scope>provided</scope>//加上这行配置，让es的xxxx-with-dependency.jar不包含druid相关包
</dependency>
```

## mvn相关操作

```shell
# 批量修改版本
mvn versions:set -DnewVersion=1.1.5
mvn versions:commit
# 构建jar
mvn compile package -Dmaven.test.skip=true
# 在根目录下构建*.tar.gz文件
mvn clean compile package -P release -Dmaven.test.skip=true
```

## 使用jdk 11

`/pom.xml` 修改 JDK 版本

```xml
<properties>
  <java_source_version>11</java_source_version>
  <java_target_version>11</java_target_version>
</properties>
```

deployer和adapter启动脚本需要移除startup.sh中的
-XX:+UseCMSCompactAtFullCollection -XX:+UseFastAccessorMethods

`adapter/conf/application.xml`

关于srcDataSource（用于ETL）

srcDataSources:
    defaultDS:
      url: jdbc:mysql://xxx.xxx.xxx.xxx:13306/test?useUnicode=true&characterEncoding=utf8&autoReconnect=true&useSSL=false

`customer.yml`

```yml
dataSourceKey: defaultDS
destination: example
groupId: g1
outerAdapterKey: example_es7 # 这边配置的值,需要与application.yam对应的outer adapter配置的key保持一致
esMapping:
  _index: customer
  _type: _doc # 虽说es7取消了这玩意，但是在修改该文件后，假如没有这玩意，adapter会报错
  _id: id
  sql: "select t.id, t.name, t.email,  concat(IFNULL(t.lat, 0), ',', IFNULL(t.lng, 0)) AS location, t.roleInfo, t.createTime from customer t"
  objFields:
#    _labels: array:;           # 数组或者对象属性, array:; 代表以;字段里面是以;分隔的
    roleInfo: object               # json对象
  etlCondition: "where t.createTime='{}'"     # etl 的条件参数
  # etlCondition: "where t.id={}"     # etl 的条件参数
  commitBatch: 10
```

## 执行编译

```shell
mvn clean compile package -Dmaven.test.skip=true
```

## es相关

官方文档: <https://github.com/alibaba/canal/wiki/Sync-ES>

1. 时间字段，在mysql中只能用int(11位)或者bigint(13位)表示时间

2. sql映射说明

```note
sql支持多表关联自由组合, 但是有一定的限制:

主表不能为子查询语句
只能使用left outer join即最左表一定要是主表
关联从表如果是子查询不能有多张表
主sql中不能有where查询条件(从表子查询中可以有where条件但是不推荐, 可能会造成数据同步的不一致, 比如修改了where条件中的字段内容)
关联条件只允许主外键的'='操作不能出现其他常量判断比如: on a.role_id=b.id and b.statues=1
关联条件必须要有一个字段出现在主查询语句中比如: on a.role_id=b.id 其中的 a.role_id 或者 b.id 必须出现在主select语句中
Elastic Search的mapping 属性与sql的查询值将一一对应(不支持 select *), 比如: select a.id as_id, a.name, a.email as _email from user, 其中name将映射到es mapping的name field,_email将 映射到mapping的_email field, 这里以别名(如果有别名)作为最终的映射字段. 这里的_id可以填写到配置文件的 _id:_id映射.
```

3. ES相关设置

```shell
# 可以直接通过Kinana设置
PUT /customer
{
 "settings": {
  "number_of_shards": 5,
  "number_of_replicas": 0
 }
}

GET /customer/_search

DELETE /customer/_doc/30yp0noBEFoBTlvUxUG4

GET /customer/_mapping

GET /customer/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all":{}
      },
      "filter": {
        "geo_distance": {
          "distance": "10m",
          "location": {
            "lat": 34.787525636245700,
            "lon": 113.669762472908500
          }
        }
      }
    }
  }
}

``

4. `mapping`设置

```json
{
  "customer" : {
    "mappings" : {
      "properties" : {
        "createTime" : {
          "type" : "date"
        },
        "email" : {
          "type" : "text"
        },
        "location" : {
          "type" : "geo_point"
        },
        "name" : {
          "type" : "text"
        },
        "roleInfo" : {
          "properties" : {
            "name" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword",
                  "ignore_above" : 256
                }
              }
            },
            "roleId" : {
              "type" : "long"
            }
          }
        }
      }
    }
  }
}
```

5. 全量同步

大批量数据初始化出现问题可参考：<https://zhuanlan.zhihu.com/p/360631964>

百度关键词`全量同步Elasticsearch方案之Canal`

`全量同步`

```shell
curl -X POST http://127.0.0.1:8081/etl/es7/example_es7/customer.yml
```

`手动ETL`

```yml
etlCondition: "where a.id>={} and a.id <={}"     # etl 的条件参数
```

```shell
curl -X POST -d "params=1;2" http://127.0.0.1:8081/etl/es7/example_es7/customer.yml 
```

`查询所有订阅同步的canal destination`

```shell
curl http://127.0.0.1:8081/destinations
```

`数据同步开关`

```shell
curl -X PUT http://127.0.0.1:8081/syncSwitch/customer/off
```

`数据同步开关状态`

```shell
curl http://127.0.0.1:8081/syncSwitch/customer
```

`查看相关库总数据`

```shell
curl http://127.0.0.1:8081/count/es7/example_es7/customer.yml
```

`手动ETL`

```shell
curl -X POST -d "params=2018-10-21 00:00:00" http://127.0.0.1:8081/etl/es7/example_es7/customer.yml 
```

## 其他

```sql
INSERT INTO `test`.`customer` (
 `id`,
 `name`,
 `email`,
 `lng`,
 `lat`,
 `roleInfo`,
 `createTime`
)
VALUES
 (
  '15',
  '111',
  '222',
  '113.669762472908500',
  '34.787525636245700',
  '{\"roleId\":1,\"name\":\"管理员\"}',
  '2147483647123'
 );

```
