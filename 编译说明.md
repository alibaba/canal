# 如何编译

## 修改POM

client-adapter.escore的pom.xml的关于druid的配置，需要设置scope为provider
之前的配置是:

```xml
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
</dependency>
```

修改之后的配置为：

```xml
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
  <scope>provided</scope>//加上这行配置，让es的xxxx-with-dependency.jar不包含druid相关包
</dependency>
```

## 批量修改版本

```shell
mvn versions:set -DnewVersion=1.1.5
mvn versions:commit
```

## 执行编译

```shell
mvn clean compile package -Dmaven.test.skip=true
```

## 使用jdk 11

deployer和adapter启动脚本需要移除startup.sh中的
-XX:+UseCMSCompactAtFullCollection -XX:+UseFastAccessorMethods

adapter/conf/application.xml关于srcDataSource

srcDataSources:
    defaultDS:
      url: jdbc:mysql://xxx.xxx.xxx.xxx:3306/test?useUnicode=true&characterEncoding=utf8&autoReconnect=true&useSSL=false

customer.yml

```yml

dataSourceKey: defaultDS
destination: example
groupId: g1
esMapping:
  _index: customer
  _type: _doc # 虽说es7取消了这玩意，但是在修改该文件后，假如没有这玩意，adapter会报错
  _id: id
  sql: "select t.id, t.name, t.email,t.c_time from customer t"
  commitBatch: 10
```

## es相关

1. 时间格式只能用int

2. ES相关设置

```shell
PUT /customer
{
 "settings": {
  "number_of_shards": 3,
  "number_of_replicas": 0
 }
}

GET /customer/_search

DELETE /customer/_doc/30yp0noBEFoBTlvUxUG4

GET /customer/_mapping
``

3. `mapping`设置

```json
{
  "customer" : {
    "mappings" : {
      "properties" : {
        
        "name" : {
          "type" : "text"
        },        
        "email" : {
          "type" : "text"
        },
        "c_time" : {
          "type" : "date"
        }
      }
    }
  }
}
```

4. 全量同步

大批量数据初始化出现问题可参考：<https://zhuanlan.zhihu.com/p/360631964>

百度关键词`全量同步Elasticsearch方案之Canal`

```shell
curl -X POST http://127.0.0.1:8081/etl/es7/customer.yml
```
