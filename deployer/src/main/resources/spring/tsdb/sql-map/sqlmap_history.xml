<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="table_meta_history">

    <typeAlias alias="metaHistoryDO" type="com.alibaba.otter.canal.parse.inbound.mysql.tsdb.model.MetaHistoryDO"/>

    <sql id="allColumns">
        <![CDATA[
		gmt_create,gmt_modified,binlog_file,binlog_offest,binlog_master_id,binlog_timestamp,use_schema,`schema`,`table`,`sql`,`type`,`extra`
        ]]>
    </sql>
    <sql id="allVOColumns">
        <![CDATA[
		a.id as id,a.gmt_create as gmtCreate,a.gmt_modified as gmtModified,
		a.binlog_file as binlogFile,a.binlog_offest as binlogOffest,a.binlog_master_id as binlogMasterId,a.binlog_timestamp as binlogTimestamp,
		a.use_schema as useSchema,a.`schema` as `schema`,a.`table` as `table`,a.`sql` as `sql`,a.`type` as `type`,a.`extra` as `extra`
        ]]>
    </sql>

    <select id="findByTimestamp" parameterClass="java.util.Map" resultClass="metaHistoryDO">
        select
        <include refid="allVOColumns"/>
        from `canal_table_meta_history$env$` a
        <![CDATA[
        where binlog_timestamp >= #snapshotTimestamp# and binlog_timestamp <= #timestamp#
        order by binlog_timestamp asc,id asc
        ]]>
    </select>

    <insert id="insert" parameterClass="metaHistoryDO">
        insert into `canal_table_meta_history` (<include refid="allColumns"/>)
        values(now(),now(),#binlogFile#,#binlogOffest#,#binlogMasterId#,#binlogTimestamp#,#useSchema#,#schema#,#table#,#sql#,#type#,#extra#);
        <selectKey resultClass="java.lang.Long" keyProperty="id">
            SELECT last_insert_id()
        </selectKey>
    </insert>


    <delete id="deleteByGmtModified" parameterClass="java.util.Map">
        <![CDATA[
		delete from `canal_table_meta_history`
		where gmt_modified < date_sub(now(),interval #interval# second)
        ]]>
    </delete>


    <select id="getAll" resultClass="metaHistoryDO">
        select * from canal_table_meta_history
    </select>

</sqlMap>