# 如何编译

## 修改POM

client-adapter.escore的pom.xml的关于druid的配置，需要设置scope为provider
之前的配置是:

```xml
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
</dependency>
```

修改之后的配置为：

```xml
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
  <scope>provided</scope>//加上这行配置，让es的xxxx-with-dependency.jar不包含druid相关包
</dependency>
```

## mvn相关操作

```shell
# 批量修改版本
mvn versions:set -DnewVersion=1.1.5
mvn versions:commit
# 在根目录下构建*.tar.gz文件
mvn clean compile package -P release -Dmaven.test.skip=true
```

## 使用jdk 11

deployer和adapter启动脚本需要移除startup.sh中的
-XX:+UseCMSCompactAtFullCollection -XX:+UseFastAccessorMethods

`adapter/conf/application.xml`

关于srcDataSource（用于ETL）

srcDataSources:
    defaultDS:
      url: jdbc:mysql://xxx.xxx.xxx.xxx:13306/test?useUnicode=true&characterEncoding=utf8&autoReconnect=true&useSSL=false

`customer.yml`

```yml
dataSourceKey: defaultDS
destination: example
groupId: g1
esMapping:
  _index: customer
  _type: _doc # 虽说es7取消了这玩意，但是在修改该文件后，假如没有这玩意，adapter会报错
  _id: id
  sql: "select t.id, t.name, t.email,  concat(IFNULL(t.lat, 0), ',', IFNULL(t.lng, 0)) AS location, t.roleInfo, t.createTime from customer t"
  objFields:
#    _labels: array:;           # 数组或者对象属性, array:; 代表以;字段里面是以;分隔的
    roleInfo: object               # json对象
  etlCondition: "where t.createTime='{}'"     # etl 的条件参数
  # etlCondition: "where t.id={}"     # etl 的条件参数
  commitBatch: 10
```

## 执行编译

```shell
mvn clean compile package -Dmaven.test.skip=true
```

## es相关

官方文档: <https://github.com/alibaba/canal/wiki/Sync-ES>

1. 时间字段，在mysql中只能用int(11位)或者bigint(13位)表示时间

2. ES相关设置

```shell
# 可以直接通过Kinana设置
PUT /customer
{
 "settings": {
  "number_of_shards": 3,
  "number_of_replicas": 0
 }
}

GET /customer/_search

DELETE /customer/_doc/30yp0noBEFoBTlvUxUG4

GET /customer/_mapping

GET /customer/_search
{
  "query": {
    "bool": {
      "must": {
        "match_all":{}
      },
      "filter": {
        "geo_distance": {
          "distance": "10m",
          "location": {
            "lat": 34.787525636245700,
            "lon": 113.669762472908500
          }
        }
      }
    }
  }
}

``

3. `mapping`设置

```json
{
  "customer" : {
    "mappings" : {
      "properties" : {
        "createTime" : {
          "type" : "date"
        },
        "email" : {
          "type" : "text"
        },
        "location" : {
          "type" : "geo_point"
        },
        "name" : {
          "type" : "text"
        },
        "roleInfo" : {
          "properties" : {
            "name" : {
              "type" : "text",
              "fields" : {
                "keyword" : {
                  "type" : "keyword",
                  "ignore_above" : 256
                }
              }
            },
            "roleId" : {
              "type" : "long"
            }
          }
        }
      }
    }
  }
}
```

4. 全量同步

大批量数据初始化出现问题可参考：<https://zhuanlan.zhihu.com/p/360631964>

百度关键词`全量同步Elasticsearch方案之Canal`

`全量同步`

```shell
curl -X POST http://127.0.0.1:8081/etl/es7/customer.yml
```

`按条件同步`

```shell
curl -X POST http://127.0.0.1:8081/etl/es7/customer.yml?params=15
```

`,多个参数之间使用 ; 分割`

```shell
curl -X POST http://127.0.0.1:8081/etl/es7/customer.yml?params=<startTime>;<endTime>
```

## 其他

```sql
INSERT INTO `test`.`customer` (
 `id`,
 `name`,
 `email`,
 `lng`,
 `lat`,
 `roleInfo`,
 `createTime`
)
VALUES
 (
  '15',
  '111',
  '222',
  '113.669762472908500',
  '34.787525636245700',
  '{\"roleId\":1,\"name\":\"管理员\"}',
  '2147483647123'
 );

```
